<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail</title>
    <link rel="stylesheet" href="<%= basePath %>/stylesheets/style.css">
    <script src="<%= basePath %>/javascripts/message-bus.js"></script>
    <script defer src="<%= basePath %>/javascripts/alpine.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-base-200 h-screen flex flex-col overflow-hidden" x-data="mailApp">

    <!-- Toolbar -->
    <div class="bg-base-100 border-b border-base-300 p-2 flex gap-2 items-center shrink-0">
        <button class="btn btn-sm btn-ghost gap-2" @click="fetchTasks()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            Actualiser
        </button>
        <div class="divider divider-horizontal m-0"></div>
        <span class="text-sm font-bold px-2">Boîte de réception</span>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-auto p-4">
        <div class="max-w-3xl mx-auto space-y-2">
            
            <template x-if="tasks.length === 0">
                <div class="text-center py-10 text-base-content/50">
                    <p class="text-lg">Aucun message</p>
                    <p class="text-sm">Votre boîte de réception est vide.</p>
                </div>
            </template>

            <template x-for="task in tasks" :key="task.id">
                <div 
                    class="card bg-base-100 shadow-sm hover:shadow-md transition-all border-l-4"
                    :class="task.completed ? 'border-success opacity-60' : 'border-primary'"
                >
                    <div class="card-body p-4 flex flex-row gap-4 items-start">
                        <!-- Avatar/Icon -->
                        <div class="avatar placeholder">
                            <div class="bg-neutral-focus text-neutral-content rounded-full w-10 h-10 flex items-center justify-center">
                                <span class="text-xl" x-text="task.completed ? '✓' : '!'"></span>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-base truncate" x-text="task.title"></h3>
                                <span class="text-xs opacity-50 whitespace-nowrap" x-text="task.completed ? 'Terminé' : 'Nouveau'"></span>
                            </div>
                            <p class="text-sm opacity-80 mt-1" x-text="task.description"></p>
                        </div>
                    </div>
                </div>
            </template>

        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('mailApp', () => ({
                tasks: [],
                init() {
                    // Listen for tasks data from parent
                    window.addEventListener('message', (event) => {
                        if (event.data && event.data.type === 'mail:updateTasks') {
                            this.tasks = event.data.data;
                        }
                    });

                    // Request initial tasks
                    this.fetchTasks();

                    // Notify parent that app is opened
                    emit('app:opened', { appId: 'mail' });
                },
                fetchTasks() {
                    emit('mail:requestTasks');
                }
            }));
        });
    </script>
</body>
</html>
